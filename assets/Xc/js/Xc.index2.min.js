document.addEventListener("DOMContentLoaded", () => {
  // 文章列表状态管理
  let listState = {
    page: window.Xc.PAGE_INDEX,
    pageSize: window.Xc.PAGE_SIZE,
    type: "created"
  };

  // 生成文章HTML模板
  const generateArticleHTML = article => {
    const {
      permalink, title, type, lazyload, image,
      abstract, created, views, commentsNum,
      agree, category
    } = article;

    const categoryDisplay = category.length ? 'flex' : 'none';
    const stickyDisplay = type === 'sticky' ? 'inline-block' : 'none';
    const categoryLink = category.length ? category[0].permalink : '';
    const categoryName = category.length ? category[0].name : '';

    return `
      <li class="Xc_home_article-si index2">
        <a href="${permalink}" class="thumbnail" title="${title}" rel="noopener noreferrer">
          <img width="100%" height="100%" class="lazyload" src="${lazyload}" data-src="${image[0]}" alt="${title}" />
        </a>
        <div class="information">
          <a href="${permalink}" class="title" title="${title}" rel="noopener noreferrer">
            <span class="badge" style="display:${stickyDisplay}">置顶</span>${title}
          </a>
          <a class="abstract" href="${permalink}" title="文章摘要" rel="noopener noreferrer">${abstract}</a>
          <div class="meta">
            <ul class="items">
              <li><svg class="icon2" aria-hidden="true"><use xlink:href="#icon-time"></use></svg>${created}</li>
              <li><svg class="icon2" aria-hidden="true"><use xlink:href="#icon-yuedu"></use></svg>${views}</li>
              <li><svg class="icon2" aria-hidden="true"><use xlink:href="#icon-pinglun"></use></svg>${commentsNum}</li>
              <li><svg class="icon2" aria-hidden="true"><use xlink:href="#icon-zan"></use></svg>${agree}</li>
            </ul>
            <div class="last" style="display:${categoryDisplay}">
              <svg class="icon2" aria-hidden="true"><use xlink:href="#icon-A21"></use></svg>
              <a class="link" rel="noopener noreferrer" href="${categoryLink}">${categoryName}</a>
            </div>
          </div>
        </div>
      </li>
    `;
  };

  // 重置文章列表
  const resetArticleList = () => {
    $(".Xc_home_article .Xc_home_article-list").html("");
    $(".Xc_load").show();
    const activeItem = $(`.Xc_home_column-title .item[data-type="${listState.type}"]`);
    const line = $(".Xc_home_column-title .line");
    activeItem.addClass("active").siblings().removeClass("active");
    line.css({});
  };

  // 加载文章列表数据
  const loadArticles = () => {
    return new Promise((resolve, reject) => {
      const $loadBtn = $(".Xc_load");
      const $loading = $(".Xc_home_article .Xc_home_article-list_loading");

      $loadBtn.attr("loading", true).html("loading...");
      $loading.show();

      $.ajax({
        url: Xc.BASE_API,
        type: "POST",
        dataType: "json",
        data: {
          routeType: "publish_list",
          page: listState.page,
          pageSize: listState.pageSize,
          type: listState.type
        },
        success(response) {
          const { data } = response;
          
          if (data.length === 0) {
            $loadBtn.removeAttr("loading").html("查看更多").hide();
            $loading.hide();
            Qmsg.warning("没有更多内容了");
            return resolve(0);
          }

          data.forEach(article => {
            $(".Xc_home_article .Xc_home_article-list").append(generateArticleHTML(article));
          });

          $loadBtn.removeAttr("loading").html("查看更多");
          $loading.hide();
          resolve(data.length > 0 ? data.length - 1 : 0);
        },
        error(err) {
          reject(err);
          Qmsg.error("加载失败，请稍后重试");
        }
      });
    });
  };

  // 初始化文章列表
  resetArticleList();
  loadArticles();

  // 绑定文章类型切换事件
  $(".Xc_home_column-title .item").on("click", async function() {
    const newType = $(this).attr("data-type");
    if (newType === listState.type) return;

    listState = {
      page: window.Xc.PAGE_INDEX,
      pageSize: window.Xc.PAGE_SIZE,
      type: newType
    };
    resetArticleList();
    await loadArticles();
  });

  // 绑定加载更多事件
  $(".Xc_load").on("click", async function() {
    if ($(this).attr("loading")) return;
    listState.page++;
    await loadArticles();
  });
});
